<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o de Rebanho</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>
<body>
    
    <div class="dashboard-header">
        <h1>{{ nome_fazenda_header if nome_fazenda_header else 'Meu Rebanho' }}</h1>
        <div class="user-controls">
            <span class="user-greeting">Ol√°, <strong>{{ current_user.username }}</strong></span>
            <a href="{{ url_for('configuracoes.settings') }}" title="Configura√ß√µes" class="btn-settings">‚öôÔ∏è</a>
            <a href="{{ url_for('auth.logout') }}" class="btn btn-danger btn-logout">Sair</a>
        </div>
    </div>

    <div class="action-bar">
        <div class="action-buttons-group">
            <a href="{{ url_for('operacional.cadastro') }}" class="btn btn-novo btn-action">+ Novo Animal</a>
            <a href="{{ url_for('financeiro.financeiro') }}" class="btn btn-novo btn-action">$ Financeiro</a>
            <a href="{{ url_for('api.graficos_page') }}" class="btn btn-novo btn-action">Meu Rebanho</a>
            <a href="{{ url_for('operacional.vacinacao_coletiva') }}" class="btn btn-vacina">üíâ Vacina em Lote</a>
        </div>

        <div id="mini-widget" class="mini-cotacao" style="display: none;">
            <span id="lbl-uf" style="text-transform: uppercase; font-weight: 800;">--</span>
            <span class="divisor">|</span>
            <span>üêÇ Boi <strong id="preco-boi">--</strong></span>
            <span class="divisor">|</span>
            <span>üêÑ Novilha <strong id="preco-novilha">--</strong></span>
            <span class="divisor">|</span>
            
            <span class="btn-ver-brasil" onclick="abrirModalBrasil()">üáßüá∑ Ver Brasil</span>
        </div>
    </div>

    <form action="{{ url_for('operacional.painel') }}" method="GET" class="search-bar search-container">
        <input type="hidden" name="status" value="{{ status }}">
        <input type="text" name="busca" class="input-busca" placeholder="Digite o n√∫mero do brinco..." value="{{ busca }}">
        <button type="submit" class="btn-buscar">üîç Buscar</button>
        {% if busca or status != 'todos' %}<a href="{{ url_for('operacional.painel') }}" class="btn-limpar">Limpar</a>{% endif %}
    </form>

    <div class="filter-bar">
        <span class="filter-label">Exibir:</span>
        <a href="{{ url_for('operacional.painel', status='todos', busca=busca) }}" class="btn btn-filter {% if status == 'todos' %}btn-primary{% else %}btn-secondary{% endif %}">Todos</a>
        <a href="{{ url_for('operacional.painel', status='ativos', busca=busca) }}" class="btn btn-filter {% if status == 'ativos' %}btn-primary{% else %}btn-secondary{% endif %}">Apenas Ativos</a>
        <a href="{{ url_for('operacional.painel', status='vendidos', busca=busca) }}" class="btn btn-filter {% if status == 'vendidos' %}btn-primary{% else %}btn-secondary{% endif %}">Apenas Vendidos</a>
        <a href="{{ url_for('operacional.lixeira') }}" class="btn btn-lixeira" title="Ver animais exclu√≠dos">üóëÔ∏è Lixeira</a>
    </div>

    <table>
        <thead>
            <tr><th>Brinco</th><th>Sexo</th><th>Data Compra</th><th>Status</th><th>A√ß√µes</th></tr>
        </thead>
        <tbody>
            {% for animal in lista_animais %}
            <tr>
                <td class="animal-brinco">{{ animal[1] }}</td> 
                <td>{{ animal[2] }}</td>
                <td>{{ animal[3] }}</td>
                <td>{% if animal[5] %}<span class="tag-vendido">VENDIDO</span>{% else %}<span class="tag-ativo">ATIVO</span>{% endif %}</td>
                <td><a href="{{ url_for('operacional.detalhes', id_animal=animal[0]) }}" class="link-detalhes">Ver Ficha &rarr;</a></td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="empty-state">Seu rebanho est√° vazio ou nenhum animal encontrado.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="pagination-container">
        {% if pagina_atual > 1 %} 
            <a href="{{ url_for('operacional.painel', page=pagina_atual-1, busca=busca, status=status) }}" class="btn btn-secondary">&laquo; Anterior</a> 
        {% else %} 
            <span class="btn btn-secondary btn-disabled">&laquo; Anterior</span> 
        {% endif %}
        
        <span class="page-info">P√°gina {{ pagina_atual }} de {{ total_paginas }}</span>
        
        {% if pagina_atual < total_paginas %} 
            <a href="{{ url_for('operacional.painel', page=pagina_atual+1, busca=busca, status=status) }}" class="btn btn-secondary">Pr√≥ximo &raquo;</a> 
        {% else %} 
            <span class="btn btn-secondary btn-disabled">Pr√≥ximo &raquo;</span> 
        {% endif %}
    </div>

    <div id="modalBrasil" class="modal-overlay" onclick="fecharModal(event)">
        <div class="modal-content">
            <span class="btn-fechar" onclick="document.getElementById('modalBrasil').style.display='none'">&times;</span>
            <h2 class="modal-title">üáßüá∑ Cota√ß√µes Nacionais</h2>
            
            <div id="loadingModal" class="modal-loading">üîÑ Carregando dados...</div>
            
            <table class="tabela-cotacao" id="tabelaModal" style="display: none;">
                <thead>
                    <tr>
                        <th>Pra√ßa / Regi√£o</th>
                        <th>Boi Gordo (Vista)</th>
                        <th>Novilha (Vista)</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaBrasil">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. CARREGAMENTO INICIAL DO WIDGET (REGIONAL)
        document.addEventListener("DOMContentLoaded", function() {
            fetch("{{ url_for('api.cotacoes_regionais') }}")
                .then(response => response.json())
                .then(data => {
                    if (data.error || (!data.boi.length && !data.novilha.length)) return;
                    document.getElementById('lbl-uf').innerText = data.uf;
                    if (data.boi.length > 0) document.getElementById('preco-boi').innerText = `R$ ${parseFloat(data.boi[0].preco_vista).toFixed(2).replace('.', ',')}`;
                    if (data.novilha.length > 0) document.getElementById('preco-novilha').innerText = `R$ ${parseFloat(data.novilha[0].preco_vista).toFixed(2).replace('.', ',')}`;
                    document.getElementById('mini-widget').style.display = 'inline-flex';
                })
                .catch(err => console.error(err));
        });

        // 2. L√ìGICA DO MODAL (BRASIL)
        function abrirModalBrasil() {
            const modal = document.getElementById('modalBrasil');
            const tbody = document.getElementById('corpoTabelaBrasil');
            const loading = document.getElementById('loadingModal');
            const tabela = document.getElementById('tabelaModal');

            modal.style.display = 'flex';
            tbody.innerHTML = '';
            loading.style.display = 'block';
            tabela.style.display = 'none';

            fetch("{{ url_for('api.cotacoes_brasil') }}")
                .then(res => res.json())
                .then(data => {
                    let html = '';
                    const listaBoi = data.boi || [];
                    const listaNovilha = data.novilha || [];
                    let mapaNovilha = {};
                    listaNovilha.forEach(item => { mapaNovilha[item.praca] = item.preco_vista; });

                    listaBoi.forEach(item => {
                        const praca = item.praca;
                        const precoBoi = parseFloat(item.preco_vista).toFixed(2).replace('.', ',');
                        let precoNov = "---";
                        if (mapaNovilha[praca]) {
                            precoNov = parseFloat(mapaNovilha[praca]).toFixed(2).replace('.', ',');
                        }

                        html += `
                            <tr>
                                <td class="praca-nome">${praca}</td>
                                <td class="preco-boi">R$ ${precoBoi}</td>
                                <td class="preco-novilha">R$ ${precoNov}</td>
                            </tr>
                        `;
                    });

                    tbody.innerHTML = html;
                    loading.style.display = 'none';
                    tabela.style.display = 'table';
                })
                .catch(err => {
                    console.error(err);
                    loading.innerText = "Erro ao carregar dados.";
                });
        }

        function fecharModal(e) {
            if (e.target.id === 'modalBrasil') {
                document.getElementById('modalBrasil').style.display = 'none';
            }
        }
    </script>
</body>
</html>