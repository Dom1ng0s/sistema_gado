<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Gráfico - Sistema Gado</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='funcionalidades.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/patternomaly/dist/patternomaly.min.js"></script>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2e7d32; padding-bottom: 10px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <h1 style="border: none; margin: 0; padding: 0; width: auto;">Meu Rebanho</h1>
            <div class="switch-wrapper">
                <label class="switch"><input type="checkbox" id="daltonicoSwitch" onchange="alternarCores()"><span class="slider"></span></label>
                <span class="label-switch">Modo Alto Contraste</span>
            </div>
        </div>
        <a href="{{ url_for('operacional.painel') }}" class="btn btn-secondary" style="padding: 5px 15px; font-size: 14px;">Voltar ao Painel</a>
    </div>

    <div class="grafico-container">
        <div class="grafico-box" style="display: block;"><h2>Composição (Sexo)</h2><canvas id="chartSexo"></canvas></div>
        <div class="grafico-box" style="display: block;"><h2>Distribuição de Peso (@)</h2><canvas id="chartPeso"></canvas></div>
        <div class="grafico-box"><h2>GMD Médio do Rebanho</h2><div class="kpi-valor" id="txtGMD">--</div><div class="kpi-sub">kg/dia (Média Global)</div></div>
    </div>

    <script>
        let chartSexo = null, chartPeso = null, dadosGlobais = null;
        const CORES_PADRAO = { sexo: ['#2e7d32', '#d32f2f'], peso: ['#81c784', '#4caf50', '#2e7d32', '#1b5e20'] };
        const CORES_TEXTURA = { sexo: [pattern.draw('diagonal', '#2196F3'), pattern.draw('dot', '#F44336')], peso: [pattern.draw('ring', '#9E9E9E'), pattern.draw('box', '#FFC107'), pattern.draw('zigzag', '#2196F3'), pattern.draw('triangle', '#F44336')] };

        function desenharGraficos(usarTexturas) {
            if (!dadosGlobais) return;
            const paleta = usarTexturas ? CORES_TEXTURA : CORES_PADRAO;
            if (chartSexo) chartSexo.destroy();
            if (chartPeso) chartPeso.destroy();

            const ctxSexo = document.getElementById('chartSexo').getContext('2d');
            chartSexo = new Chart(ctxSexo, { type: 'doughnut', data: { labels: ['Machos', 'Fêmeas'], datasets: [{ data: [dadosGlobais.sexo.M || 0, dadosGlobais.sexo.F || 0], backgroundColor: paleta.sexo, borderWidth: 1 }] }, options: { plugins: { legend: { position: 'bottom' } } } });

            const ctxPeso = document.getElementById('chartPeso').getContext('2d');
            chartPeso = new Chart(ctxPeso, { type: 'pie', data: { labels: Object.keys(dadosGlobais.peso), datasets: [{ data: Object.values(dadosGlobais.peso), backgroundColor: paleta.peso, borderWidth: 1 }] }, options: { plugins: { legend: { position: 'bottom' } } } });

            const valorGMD = dadosGlobais.gmd_medio ? dadosGlobais.gmd_medio.toFixed(3) : "0.000";
            document.getElementById('txtGMD').innerText = valorGMD;
        }

        function alternarCores() { desenharGraficos(document.getElementById('daltonicoSwitch').checked); }

        fetch("{{ url_for('api.dados_graficos_api') }}")
            .then(res => res.json())
            .then(dados => {
                if(dados.error) { alert("Erro: " + dados.error); } else { dadosGlobais = dados; desenharGraficos(false); }
            })
            .catch(err => console.error(err));
    </script>
</body>
</html>