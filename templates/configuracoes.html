<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Configura√ß√µes da Fazenda</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='funcionalidades.css') }}">
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2e7d32; padding-bottom: 10px; margin-bottom: 20px;">
        <h1 style="border: none; margin: 0; padding: 0;">‚öôÔ∏è Configura√ß√µes</h1>
        <a href="{{ url_for('operacional.painel') }}" class="btn btn-secondary">Voltar ao Painel</a>
    </div>

    {% if mensagem %}
        <div class="alert" style="max-width: 600px; margin: 0 auto 20px auto;">
            {{ mensagem }}
        </div>
    {% endif %}

    <div class="config-card">
        <form action="{{ url_for('configuracoes.settings') }}" method="POST">
            
            <div class="form-group">
                <label>Nome da Propriedade:</label>
                <input type="text" name="nome_fazenda" 
                       value="{{ config.nome if config.nome else '' }}" 
                       placeholder="Ex: Fazenda Santa F√©" required>
            </div>

            <div class="form-group">
                <label>Localiza√ß√£o (Cidade - UF):</label>
                <input type="text" name="cidade_estado" id="inputCidade" list="listaCidades"
                       value="{{ config.cidade if config.cidade else '' }}" 
                       placeholder="Digite para buscar..." autocomplete="off">
                
                <datalist id="listaCidades"></datalist>
                
                <div class="info-ibge" id="statusIBGE">üîÑ Carregando cidades do IBGE...</div>
            </div>

            <div class="form-group">
                <label>√Årea Total (Hectares):</label>
                <input type="number" step="0.01" name="area_total" 
                       value="{{ config.area if config.area else '' }}" 
                       placeholder="0.00">
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px; font-size: 1.1em;">üíæ SALVAR ALTERA√á√ïES</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const dataList = document.getElementById('listaCidades');
            const statusMsg = document.getElementById('statusIBGE');
            const inputCidade = document.getElementById('inputCidade');

            const url = "{{ url_for('api.proxy_cidades') }}";

            statusMsg.innerText = "üåê Consultando API de cidades...";

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error("Erro na comunica√ß√£o com o servidor");
                    return response.json();
                })
                .then(cidades => {
                    if (cidades.error) throw new Error(cidades.error);
                    
                    let options = '';
                    cidades.sort((a, b) => a.nome.localeCompare(b.nome));
                    cidades.forEach(c => {
                        options += `<option value="${c.nome} - ${c.uf}">`;
                    });
                    
                    dataList.innerHTML = options;
                    statusMsg.innerHTML = "‚úÖ API Conectada (Dados Atualizados)";
                    statusMsg.style.color = "green";
                    inputCidade.placeholder = "Digite a cidade...";
                })
                .catch(err => {
                    console.error('Erro:', err);
                    statusMsg.innerText = "‚ùå Falha na API. Verifique a internet do servidor.";
                    statusMsg.style.color = "red";
                });
        });
    </script>
</body>
</html>